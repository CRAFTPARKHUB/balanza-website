import create from"zustand";import{persist}from"zustand/middleware";import{useState,useEffect}from"react";import{parseShopifyData}from"https://framerusercontent.com/modules/gd3dcT3w5rYoRy7ZcKte/sH6FZizM8jJ11j2dQOhQ/Shared.js";const CART_ID_STORAGE_ID="frameship-shopify-cart-id";const
frameshipDataCache={};async function fetchShopifyData(query,variables={}){const{shopUrl,accessToken}=getFrameshipInfo();if(!shopUrl||!accessToken){console.warn("Missing shop URL or access token");return null;}try{const response=await fetch(`https://${shopUrl}/api/2024-10/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":accessToken},body:JSON.stringify({query,variables})});const
value=await response.json();return value?value.data:null;}catch(error){console.error(error);return null;}}// Add this shared fragment for cart fields const CART_FRAGMENT=` fragment CartFields on Cart { id checkoutUrl cost { subtotalAmount { amount currencyCode
} } lines(first: 10) { edges { node { id quantity cost { subtotalAmount { amount currencyCode } compareAtAmountPerQuantity { amount currencyCode } } merchandise { ... on ProductVariant { id title price { amount currencyCode } } } } } } } `;export const
useCartStore=create(persist((set,get)=>({cartId:null,items:[],loading:false,error:null,checkoutUrl:null,subtotal:null,initializeCart:async(createNewCart=false)=>{if(get().items.length>0){return;}set({loading:true});try{const cartId=get().cartId;if(cartId){const
cart=await fetchCart(cartId);set({items:cart.lines.edges.map(edge=>edge.node),checkoutUrl:generateCheckoutUrl(cart.checkoutUrl),subtotal:cart.cost.subtotalAmount,loading:false});}else if(createNewCart){const newCart=await createCart();set({cartId:newCart.id,items:[],checkoutUrl:generateCheckoutUrl(newCart.checkoutUrl),subtotal:newCart.cost.subtotalAmount,loading:false});}}catch(error){set({error:error.message,loading:false});}},addToCart:async(variantId,quantity)=>{set({loading:true});try{//
Initialize cart if needed if(!get().cartId){await get().initializeCart(true);}const cartId=get().cartId;const updatedCart=await addToCart(cartId,variantId,quantity);set({items:updatedCart.lines.edges.map(edge=>edge.node),subtotal:updatedCart.cost.subtotalAmount,loading:false});}catch(error){set({error:error.message,loading:false});}},removeFromCart:async
lineId=>{set({loading:true});try{const cartId=get().cartId;const updatedCart=await removeFromCart(cartId,lineId);set({items:updatedCart.lines.edges.map(edge=>edge.node),subtotal:updatedCart.cost.subtotalAmount,loading:false});}catch(error){set({error:error.message,loading:false});}},setCartItemQuantity:async(lineId,quantity)=>{set({loading:true});try{const
cartId=get().cartId;const updatedCart=await updateCartLineQuantity(cartId,lineId,quantity);set({items:updatedCart.lines.edges.map(edge=>edge.node),subtotal:updatedCart.cost.subtotalAmount,loading:false});}catch(error){set({error:error.message,loading:false});}},getCheckoutUrl:()=>{return
get().checkoutUrl||"";},clearError:()=>set({error:null})}),{name:CART_ID_STORAGE_ID,partialize:state=>({cartId:state.cartId})}));async function createCart(){const mutation=` ${CART_FRAGMENT} mutation { cartCreate { cart { ...CartFields } } } `;const data=await
fetchShopifyData(mutation);return data?data.cartCreate.cart:null;}async function fetchCart(cartId){const query=` ${CART_FRAGMENT} query($cartId: ID!) { cart(id: $cartId) { ...CartFields } } `;const variables={cartId};const data=await fetchShopifyData(query,variables);return
data?data.cart:null;}async function addToCart(cartId,variantId,quantity){const mutation=` ${CART_FRAGMENT} mutation($cartId: ID!, $lines: [CartLineInput!]!) { cartLinesAdd(cartId: $cartId, lines: $lines) { cart { ...CartFields } userErrors { field message
} } } `;const variables={cartId,lines:[{quantity:quantity,merchandiseId:variantId}]};try{const data=await fetchShopifyData(mutation,variables);if(data&&data.cartLinesAdd.userErrors.length>0){const cartNotFoundError=data.cartLinesAdd.userErrors.find(e=>e.message==="The
specified cart does not exist.");if(cartNotFoundError){// Create new cart and retry adding the item const newCart=await createCart();const retryVariables={cartId:newCart.id,lines:[{quantity:quantity,merchandiseId:variantId}]};const retryData=await fetchShopifyData(mutation,retryVariables);if(retryData&&retryData.cartLinesAdd.userErrors.length>0){throw
new Error(retryData.cartLinesAdd.userErrors.map(e=>e.message).join(", "));}return retryData.cartLinesAdd.cart;}throw new Error(data.cartLinesAdd.userErrors.map(e=>e.message).join(", "));}return data?data.cartLinesAdd.cart:null;}catch(error){throw error;}}async
function removeFromCart(cartId,lineId){const mutation=` ${CART_FRAGMENT} mutation($cartId: ID!, $lineIds: [ID!]!) { cartLinesRemove(cartId: $cartId, lineIds: $lineIds) { cart { ...CartFields } } } `;const variables={cartId,lineIds:[lineId]};const data=await
fetchShopifyData(mutation,variables);return data?data.cartLinesRemove.cart:null;}export async function getAmountInStock(productId){const query=` query getInventory($id: ID!) { product(id: $id) { variants(first: 100) { edges { node { id quantityAvailable
} } } } } `;const variables={id:productId};try{const data=await fetchShopifyData(query,variables);const inventoryByVariant={};if(data){for(const edge of data.product.variants.edges){inventoryByVariant[edge.node.id]=edge.node.quantityAvailable;}}return
inventoryByVariant;}catch(error){console.error("Error fetching inventory:",error);throw error;}}export function useAmountInStock(shopifyData){const{shopifyId}=parseShopifyData(shopifyData);const[inventory,setInventory]=useState({});const[isLoading,setIsLoading]=useState(true);useEffect(()=>{setIsLoading(true);getAmountInStock(shopifyId).then(value=>{setInventory(value);setIsLoading(false);});},[shopifyId]);return[inventory,isLoading];}async
function updateCartLineQuantity(cartId,lineId,quantity){const mutation=` ${CART_FRAGMENT} mutation($cartId: ID!, $lines: [CartLineUpdateInput!]!) { cartLinesUpdate(cartId: $cartId, lines: $lines) { cart { ...CartFields } userErrors { field message } }
} `;const variables={cartId,lines:[{id:lineId,quantity:quantity}]};const data=await fetchShopifyData(mutation,variables);if(data&&data.cartLinesUpdate.userErrors.length>0){throw new Error(data.cartLinesUpdate.userErrors.map(e=>e.message).join(", "));}return
data?data.cartLinesUpdate.cart:null;}export async function generateBuyNowCheckoutUrl(variantId,quantity=1){const mutation=` mutation($input: CartInput!) { cartCreate(input: $input) { cart { checkoutUrl } userErrors { field message } } } `;const variables={input:{lines:[{quantity:quantity,merchandiseId:variantId}]}};try{const
data=await fetchShopifyData(mutation,variables);if(data&&data.cartCreate.userErrors.length>0){throw new Error(data.cartCreate.userErrors.map(e=>e.message).join(", "));}return data?generateCheckoutUrl(data.cartCreate.cart.checkoutUrl):null;}catch(error){console.error("Error
creating buy now cart:",error);throw error;}}export function getFrameshipInfo(){let shopUrl="";let accessToken="";let stagingDomain="";let productionDomain="";let isCreatorLicense=false;let hasAccess=false;if(typeof document!=="undefined"&&typeof window!=="undefined"){const
hostname=window.location.hostname;const isPreview=hostname.endsWith(".framercanvas.com");if(isPreview){hasAccess=true;}// First check for meta tag const frameshipMetaTag=document.querySelector('meta[name="frameship-id"]');if(frameshipMetaTag){const frameshipId=frameshipMetaTag.getAttribute("content")||"";const
frameshipData=parseFrameshipData(frameshipId);const newHasAccess=hasFrameshipAccess(frameshipData.stagingDomain,frameshipData.productionDomain);hasAccess=newHasAccess;if(hasAccess){shopUrl=frameshipData.shopUrl||"";accessToken=frameshipData.shopifyAccessToken||"";stagingDomain=frameshipData.stagingDomain||"";productionDomain=frameshipData.productionDomain||"";isCreatorLicense=frameshipData.isCreatorLicense??false;}}else{//
Fall back to div element approach const frameshipIdComponent=document.querySelector("div[data-frameship-id]");if(frameshipIdComponent){const frameshipId=frameshipIdComponent.getAttribute("data-frameship-id")||"";const frameshipData=parseFrameshipData(frameshipId);const
newHasAccess=hasFrameshipAccess(frameshipData.stagingDomain,frameshipData.productionDomain);hasAccess=newHasAccess;if(hasAccess){shopUrl=frameshipData.shopUrl||"";accessToken=frameshipData.shopifyAccessToken||"";stagingDomain=frameshipData.stagingDomain||"";productionDomain=frameshipData.productionDomain||"";isCreatorLicense=frameshipData.isCreatorLicense??false;}}else{const
frameshipComponent=document.querySelector("div[data-frameship-component]");if(frameshipComponent){const newStagingDomain=frameshipComponent.getAttribute("data-staging-domain")||"";const newProductionDomain=frameshipComponent.getAttribute("data-production-domain")||"";const
newHasAccess=hasFrameshipAccess(newStagingDomain,newProductionDomain);hasAccess=newHasAccess;if(hasAccess){shopUrl=frameshipComponent.getAttribute("data-shop-url")||"";accessToken=frameshipComponent.getAttribute("data-shopify-access-token")||"";stagingDomain=newStagingDomain;productionDomain=newProductionDomain;}}}}}else{hasAccess=true//
Show as having access in optimized version of site ;}return{shopUrl,accessToken,stagingDomain,productionDomain,hasAccess,isCreatorLicense};}export function hasFrameshipAccess(stagingDomain,productionDomain){if(typeof document==="undefined"||typeof window==="undefined"){return
true;}const hostname=window.location.hostname;const isPreview=hostname.endsWith(".framercanvas.com");const stagingDomainValue=(stagingDomain||"").replace("https://","");const productionDomainValue=(productionDomain||"").replace("https://","");if(isPreview||hostname===stagingDomainValue||hostname===productionDomainValue){return
true;}else{return false;}}export function parseFrameshipData(frameshipData){if(!frameshipData||typeof frameshipData!=="string"){return{};}if(frameshipDataCache.hasOwnProperty(frameshipData)){return frameshipDataCache[frameshipData];}try{const decoded=decodeFromBase64WithoutPadding(rot13(reverseString(frameshipData)));const
data=JSON.parse(decoded);// Validate required properties exist if(!data||typeof data!=="object"){return{};}const value={shopUrl:typeof data.a==="string"?data.a:"",shopifyAccessToken:typeof data.b==="string"?data.b:"",productionDomain:typeof data.c==="string"?data.c:"",stagingDomain:typeof
data.d==="string"?data.d:"",isCreatorLicense:typeof data.e==="boolean"?data.e:false};frameshipDataCache[frameshipData]=value;return value;}catch(error){return{};}}function decodeFromBase64WithoutPadding(base64WithoutPadding){try{// Calculate and add back
the required padding const padding=base64WithoutPadding.length%4;const paddedBase64=padding?base64WithoutPadding+"=".repeat(4-padding):base64WithoutPadding;// Decode the base64 string back to the original string return atob(paddedBase64);}catch(error){console.error("Error
decoding base64:",error);return"";}}function rot13(str){return str.replace(/[A-Za-z]/g,function(char){const charCode=char.charCodeAt(0);const baseCharCode=char.toUpperCase()===char?65:97;return String.fromCharCode((charCode-baseCharCode+13)%26+baseCharCode);});}function
reverseString(str){return str.split("").reverse().join("");}function generateCheckoutUrl(checkoutUrl){const{isCreatorLicense}=getFrameshipInfo();return isCreatorLicense?"https://frameship.io/":checkoutUrl;} export const __FramerMetadata__ = {"exports":{"hasFrameshipAccess":{"type":"function","annotations":{"framerContractVersion":"1"}},"useCartStore":{"type":"variable","annotations":{"framerContractVersion":"1"}},"parseFrameshipData":{"type":"function","annotations":{"framerContractVersion":"1"}},"getAmountInStock":{"type":"function","annotations":{"framerContractVersion":"1"}},"useAmountInStock":{"type":"function","annotations":{"framerContractVersion":"1"}},"generateBuyNowCheckoutUrl":{"type":"function","annotations":{"framerContractVersion":"1"}},"getFrameshipInfo":{"type":"function","annotations":{"framerContractVersion":"1"}},"__FramerMetadata__":{"type":"variable"}}}